<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>WebAR Marker Detection</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawcdn.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs>
      <!-- Assets -->
      <a-assets>
        <!-- マーカーの定義 -->
        <a-marker preset="custom" type="pattern" url="Project/assets/marker/patt/marker_03.patt" id="marker_03"></a-marker>

      </a-assets>

      <!-- カメラ -->
      <a-entity camera></a-entity>

      <!-- マーカーを処理するスクリプト -->
      <script>
        AFRAME.registerComponent("marker-handler", {
          init: function () {
            this.el.addEventListener("markerFound", (evt) => {
              const marker = evt.target;
              const markerId = marker.id;
              const markerPosition = marker.object3D.position;

              // 中心点の赤いプロット
              const centerPoint = document.createElement("a-sphere");
              centerPoint.setAttribute("radius", "0.02");
              centerPoint.setAttribute("color", "red");
              centerPoint.setAttribute("position", markerPosition);
              this.el.sceneEl.appendChild(centerPoint);

              // 頂点の緑色のプロット
              const vertices = [
                { x: 0.05, y: 0, z: 0.05 }, // マーカーの4つの頂点に位置調整
                { x: -0.05, y: 0, z: 0.05 },
                { x: -0.05, y: 0, z: -0.05 },
                { x: 0.05, y: 0, z: -0.05 },
              ];
              vertices.forEach((vertex) => {
                const vertexPoint = document.createElement("a-sphere");
                vertexPoint.setAttribute("radius", "0.01");
                vertexPoint.setAttribute("color", "green");
                vertexPoint.setAttribute(
                  "position",
                  `${markerPosition.x + vertex.x} ${markerPosition.y} ${
                    markerPosition.z + vertex.z
                  }`
                );
                this.el.sceneEl.appendChild(vertexPoint);
              });

              // 同じ種類のマーカーの中心点を結ぶ青い直線
              const markers = document.querySelectorAll(`#${markerId}`);
              markers.forEach((otherMarker) => {
                if (otherMarker !== marker) {
                  const otherPosition = otherMarker.object3D.position;
                  const line = document.createElement("a-entity");
                  line.setAttribute("line", {
                    start: `${markerPosition.x} ${markerPosition.y} ${markerPosition.z}`,
                    end: `${otherPosition.x} ${otherPosition.y} ${otherPosition.z}`,
                    color: "blue",
                  });
                  this.el.sceneEl.appendChild(line);
                }
              });
            });
          },
        });

        // 各マーカーにコンポーネントをアタッチ
        document.querySelector("#marker_03").setAttribute("marker-handler", "");

      </script>
    </a-scene>
  </body>
</html>
